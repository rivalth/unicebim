openapi: 3.0.3
info:
  title: UniCebim API
  version: 0.1.0
  description: |
    UniCebim (Student Budget Tracker) MVP API specification.

    Notes:
    - Auth is handled via Supabase session cookies in the web app.
    - Endpoints below assume an authenticated session for protected routes.
    - All protected endpoints require valid Supabase SSR session cookies.
servers:
  - url: http://localhost:3000

tags:
  - name: Health
  - name: Profile
  - name: Transactions

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Health check endpoint with system information
      description: |
        Returns service health status along with build metadata, uptime, and runtime information.
        Useful for monitoring and diagnostics. No authentication required.
      responses:
        "200":
          description: OK
          headers:
            etag:
              description: Weak ETag for caching
              schema:
                type: string
              example: W/"abc123"
            cache-control:
              description: Cache control directives
              schema:
                type: string
              example: "public, max-age=0, s-maxage=60, stale-while-revalidate=300"
            x-request-id:
              description: Request correlation ID
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                required: [ok, service, timestamp, uptime, build, runtime]
                properties:
                  ok:
                    type: boolean
                    description: Service health status (always true if endpoint responds)
                  service:
                    type: string
                    example: "unicebim"
                  timestamp:
                    type: string
                    format: date-time
                    description: ISO 8601 timestamp of the health check response
                  uptime:
                    type: object
                    required: [seconds, milliseconds, formatted]
                    description: Server process uptime information
                    properties:
                      seconds:
                        type: integer
                        description: Uptime in seconds
                        example: 3600
                      milliseconds:
                        type: integer
                        description: Uptime in milliseconds
                        example: 3600000
                      formatted:
                        type: string
                        description: Human-readable uptime format
                        example: "1h"
                  build:
                    type: object
                    description: Optional build metadata for diagnostics (no secrets)
                    properties:
                      version:
                        type: string
                        nullable: true
                        description: Application version (from NEXT_PUBLIC_APP_VERSION)
                      commitSha:
                        type: string
                        nullable: true
                        description: Git commit SHA (from VERCEL_GIT_COMMIT_SHA)
                      environment:
                        type: string
                        nullable: true
                        description: Deployment environment (production, preview, development)
                  runtime:
                    type: object
                    required: [nodeVersion, platform, arch]
                    description: Node.js runtime information
                    properties:
                      nodeVersion:
                        type: string
                        example: "v20.10.0"
                      platform:
                        type: string
                        example: "linux"
                      arch:
                        type: string
                        example: "x64"
        "304":
          description: Not Modified (cached response, use If-None-Match header)

  /api/profile:
    get:
      tags: [Profile]
      summary: Get current user's profile
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProfileResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      tags: [Profile]
      summary: Update current user's monthly budget goal
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMonthlyBudgetGoalRequest"
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProfileResponse"
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (CSRF protection)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Too many requests (rate limited)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "413":
          description: Payload too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "415":
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/transactions:
    get:
      tags: [Transactions]
      summary: List transactions for the current user (optional month filter, supports pagination)
      security:
        - cookieAuth: []
      parameters:
        - name: month
          in: query
          required: false
          schema:
            type: string
            pattern: "^\\d{4}-\\d{2}$"
          description: Month filter in YYYY-MM format (UTC month boundaries).
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
          description: Page size (defaults to a reasonable server-side limit).
        - name: cursor
          in: query
          required: false
          schema:
            type: string
          description: Opaque cursor returned as `nextCursor` for keyset pagination.
      responses:
        "200":
          description: Transactions + monthly summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListTransactionsResponse"
        "400":
          description: Invalid query parameters (e.g. invalid month/cursor/limit)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags: [Transactions]
      summary: Create a transaction for the current user
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTransactionRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                required: [transaction]
                properties:
                  transaction:
                    $ref: "#/components/schemas/Transaction"
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (CSRF protection)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Too many requests (rate limited)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "413":
          description: Payload too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "415":
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sb-access-token
      description: |
        Supabase SSR (Server-Side Rendering) session authentication using HTTP-only cookies.

        ## Cookie Details

        The web app uses Supabase's `@supabase/ssr` package which manages session cookies automatically:

        - **`sb-access-token`**: JWT access token (short-lived, typically 1 hour)
        - **`sb-refresh-token`**: Refresh token used to obtain new access tokens (long-lived)

        Both cookies are:
        - HTTP-only (not accessible via JavaScript for security)
        - Secure (only sent over HTTPS in production)
        - SameSite=Lax (protects against CSRF)

        ## How Authentication Works

        1. User logs in via `/api/auth/callback` or Server Actions (`loginAction`, `registerAction`)
        2. Supabase SSR middleware sets session cookies in the response
        3. Subsequent requests to protected endpoints include these cookies automatically
        4. Server-side route handlers and Server Actions validate the session using `createSupabaseServerClient()`
        5. If access token expires, middleware automatically refreshes it using the refresh token

        ## For API Clients (cURL, Postman, etc.)

        To authenticate API requests manually:

        1. Login via the web app and capture cookies from browser DevTools
        2. Include both `sb-access-token` and `sb-refresh-token` cookies in requests
        3. Handle token refresh if access token expires (or use refresh token endpoint)

        ## Security Notes

        - Cookies are automatically included by browsers but must be manually set for API clients
        - CSRF protection is enforced for state-changing operations (POST/PATCH/DELETE)
        - Rate limiting applies to all authenticated endpoints
        - Session validation happens on every request via Supabase RLS policies

  schemas:
    ErrorResponse:
      type: object
      required: [message, code, requestId]
      properties:
        message:
          type: string
        code:
          type: string
          description: Machine-readable error code.
        requestId:
          type: string
          description: Correlation id returned as `x-request-id` header as well.
        issues:
          type: object
          description: Optional validation issues keyed by field name.
          additionalProperties:
            type: array
            items:
              type: string

    TransactionType:
      type: string
      enum: [income, expense]

    TransactionCategory:
      type: string
      description: Hardcoded MVP categories (no custom categories).
      enum:
        - "KYK/Burs"
        - "Aile Harçlığı"
        - "Freelance/Ek İş"
        - "Sosyal/Keyif"
        - "Beslenme"
        - "Ulaşım"
        - "Sabitler"
        - "Okul"

    Transaction:
      type: object
      required: [id, amount, type, category, date]
      properties:
        id:
          type: string
          format: uuid
        amount:
          type: number
        type:
          $ref: "#/components/schemas/TransactionType"
        category:
          $ref: "#/components/schemas/TransactionCategory"
        date:
          type: string
          format: date-time

    MonthlySummary:
      type: object
      required: [incomeTotal, expenseTotal, netTotal]
      properties:
        incomeTotal:
          type: number
        expenseTotal:
          type: number
        netTotal:
          type: number

    ListTransactionsResponse:
      type: object
      required: [month, summary, transactions]
      properties:
        month:
          type: string
          pattern: "^\\d{4}-\\d{2}$"
        summary:
          $ref: "#/components/schemas/MonthlySummary"
        transactions:
          type: array
          items:
            $ref: "#/components/schemas/Transaction"
        nextCursor:
          type: string
          nullable: true
          description: Opaque cursor for the next page (present when more data exists).

    CreateTransactionRequest:
      type: object
      required: [amount, type, category, date]
      properties:
        amount:
          type: number
        type:
          $ref: "#/components/schemas/TransactionType"
        category:
          $ref: "#/components/schemas/TransactionCategory"
        date:
          type: string
          format: date
          description: Date-only string (YYYY-MM-DD).

    Profile:
      type: object
      required: [id, full_name, monthly_budget_goal, monthly_fixed_expenses]
      properties:
        id:
          type: string
          format: uuid
        full_name:
          type: string
          nullable: true
        monthly_budget_goal:
          type: number
          nullable: true
        monthly_fixed_expenses:
          type: number
          nullable: true

    GetProfileResponse:
      type: object
      required: [profile]
      properties:
        profile:
          $ref: "#/components/schemas/Profile"
          nullable: true

    UpdateMonthlyBudgetGoalRequest:
      type: object
      properties:
        monthlyBudgetGoal:
          type: number
          nullable: true
      description: |
        Updates the user's monthly budget goal.

        Note: `monthly_fixed_expenses` is derived from `fixed_expenses` rows and is not directly writable.


